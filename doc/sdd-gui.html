<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
<HEAD>
    <META NAME="Generator" CONTENT="Cosmo Create 1.0.3">
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso-8859-1">
    <META NAME="Description" CONTENT="Common UNIX Printing System Software Design Description">
    <META NAME="COPYRIGHT" CONTENT="Copyright 1997-1998, All Rights Reserved">
    <META NAME="DOCNUMBER" CONTENT="CUPS-SDD-1.0">
    <META NAME="Author" CONTENT="Easy Software Products">
    <TITLE>DRAFT - CUPS Software Design Description - DRAFT</TITLE>
</HEAD>
<BODY>
<H1>
Scope</H1>
<H2>
Identification</H2>
<P>
This software design description document provides detailed information 
on the architecture and coding of the Common UNIX Printing System 
(&quot;CUPS&quot;) Version 1.0. </P>
<H2>
System Overview</H2>
<P>
The Common UNIX Printing System provides a portable printing layer for 
UNIX&#174; operating systems. It has been developed by Easy Software 
Products to promote a standard printing solution for all UNIX vendors 
and users. </P>
<P>
CUPS provides both the System V and Berkeley user interfaces and 
utilizes the Internet Printing Protocol (IETF-IPP) as the basis for 
sending remote print jobs. CUPS adds network printer browsing and 
PostScript Printer Description (&quot;PPD&quot;)-based printing options 
to support real world applications under UNIX. </P>
<H2>
Document Overview</H2>
<P>
This software design description document is organized into the 
following sections: </P>
<UL>
    <LI>
    1 - Scope
    <LI>
    2 - References
    <LI>
    3 - Preliminary Design
    <LI>
    4 - Detailed Design
    <LI>
    A - Glossary
</UL>
<H1>
References</H1>
<H2>
CUPS Documentation</H2>
<P>
The following CUPS documentation is referenced by this document: </P>
<UL>
    <LI>
    CUPS-CMP-1.0: CUPS Configuration Management Plan
    <LI>
    CUPS-IDD-1.0: CUPS System Interface Design Description
    <LI>
    CUPS-SAM-1.0.0: CUPS Software Administrators Manual
    <LI>
    CUPS-SCHED-SDD-1.0: CUPS Scheduler Software Design Description
    <LI>
    CUPS-POSIX-SDD-1.0: CUPS POSIX Interface Software Design Description
    <LI>
    CUPS-BSD-SDD-1.0: CUPS Berkeley Interface Software Design Description
    <LI>
    CUPS-SYSV-SDD-1.0: CUPS System V Interface Software Design Description
    <LI>
    CUPS-GUI-SDD-1.0: CUPS Graphical User-Interface Software Design 
    Description
    <LI>
    CUPS-SSR-1.0: CUPS Software Security Report
    <LI>
    CUPS-STP-1.0: CUPS Software Test Plan
    <LI>
    CUPS-SUM-1.0.0: CUPS Software Users Manual
    <LI>
    CUPS-SVD-1.0.0: CUPS Software Version Description
</UL>
<H2>
Other Documents</H2>
<P>
The following non-CUPS documents are referenced by this document: </P>
<UL>
    <LI>
    IEEE 1387.4, System Administration: Printing (draft)
    <LI>
    IETF-IPP, Internet Printing Protocol (draft)
    <LI>
    RFC 1179, Line Printer Daemon Protocol
</UL>
<H1>
Preliminary Design</H1>
<H2 VALUE="0">
Sub-System Overview</H2>
<P>
CUPS is composed of ??? software sub-systems that operate together to 
perform common printing tasks. </P>
<H2>
Scheduler</H2>
<P>
The <I>scheduler</I> sub-system handles all printer management and 
queuing functions of CUPS and maintains a database of available local 
and remote printers and classes. The scheduler's operation can be 
broken into three parts: </P>
<UL>
    <LI>
    Command Processing
    <LI>
    Job Processing
    <LI>
    HTTP Interface
</UL>
<H3>
Command Processing</H3>
<P>
The following commands are understood by the <I>scheduler</I>
 sub-system. Each command sends a response back to the <I>interface 
library</I> sub-system indicating the success or failure of the 
command, plus any additional data specific to the command. </P>
<H4 TYPE="a">
Add Printer</H4>
<P>
The <I>add printer</I> command adds the specified printer to the list 
of available local printers. The printer name, universal resource 
locator (&quot;URL&quot;), interface script, PPD file, class(es), and 
location information are provided in this message. </P>
<P>
This command requires administrative priviledges. </P>
<H4>
Remove Printer</H4>
<P>
The <I>remove printer</I> command removes the specified printer from 
the list of available local printers. The printer name is provided in 
this message. </P>
<P>
This command requires administrative priviledges. </P>
<H4>
Update Printer</H4>
<P>
The <I>update printer</I> command reconfigures the specified local 
printer. The printer name, universal resource locator 
(&quot;URL&quot;), interface script, PPD file, class(es), and location 
information are provided in this message. </P>
<P>
This command requires administrative priviledges. </P>
<H4>
Query Printer</H4>
<P>
The <I>query printer</I> command returns the current configuration of 
the specified local printer. The printer name is provided in this 
message. </P>
<H4>
Find Printers</H4>
<P>
The <I>find printer</I> command returns zero or more printers that 
match the specified printer name, class, location, and option 
information. [note: describe somewhere that you can look for options 
like ColorDevice=True, Resolution=1200dpi, etc.] </P>
<H4>
Queue File</H4>
<P>
The <I>queue file</I> command queues a file for printing to the 
specified printer or class. The printer or class name, filename, title, 
priority, number of copies, and option(s) are provided in this message. </P>
<H4>
Unqueue File</H4>
<P>
The <I>unqueue file</I> command removes a file from the print queue if 
it is queued or printing. The printer or class name and filename are 
provided in this message. </P>
<P>
You must be the queuer of the file or have administrative priviledges 
to use this command. </P>
<H4>
Requeue File</H4>
<P>
The <I>requeue file</I> command moves a file for printing to the 
specified printer or class. The printer or class name, priority, number 
of copies, and filename are provided in this message. </P>
<P>
You must be the queuer of the file or have administrative priviledges 
to use this command. </P>
<H4>
Get Printer Status</H4>
<P>
The <I>get printer status</I> command returns the current printer 
status of the specified printer. The printer name is provided in this 
message. </P>
<H4>
Set Printer Status</H4>
<P>
The <I>set printer status</I> command sets the current printer status 
of the specified printer. The printer name, status code, and status 
text is provided in this message. </P>
<P>
This command requires administrative priviledges. </P>
<H4>
Get Printer Access</H4>
<P>
The <I>get printer access</I> command gets the page/access limits for a 
printer and/or user. </P>
<H4>
Set Printer Access</H4>
<P>
The <I>set printer access</I> command sets the page/access limits for a 
printer and/or user. </P>
<P>
This command requires administrative priviledges. </P>
<H4>
Get PPD File</H4>
<P>
The <I>get ppd file</I> command returns the PPD file for the specified 
printer. The printer name is provided in this message. </P>
<H4>
Get Queue Status</H4>
<P>
The <I>get queue status</I> command returns the current list of files 
queued for printing on the specified printer or class. The printer or 
class name is provided in this message. </P>
<H4>
Get Default Options</H4>
<P>
The <I>get default options</I> command returns the current default 
options for the specified printer. The printer name is provided in this 
message. </P>
<H4>
Set Default Options</H4>
<P>
The <I>set default options</I> command sets the current default options 
for the specified printer. The printer name and options are provided in 
this message. </P>
<H4>
Get Page List</H4>
<P>
The <I>get page list</I> command returns a list of pages sent to the 
specified printer. You can optionally send user or group names and a 
date/time range to restrict the pages returned. </P>
<H4>
Clear Page List</H4>
<P>
The <I>clear page list</I> command clears the page list for the 
specified printer. </P>
<P>
This command required administrative priviledges. </P>
<H4>
Check Pages</H4>
<P>
The <I>check pages</I> command checks to see if the specified user can 
print another page to the specified printer. </P>
<H4>
Log Page</H4>
<P>
The <I>log page</I> command logs that a page has been printed on the 
specified printer. The printer name, job ID, job title, username, and 
print type/options are send in this message. </P>
<H3>
Job Processing</H3>
<P>
Files are processed in round-robin fashion based upon the job priority 
and order of queuing. Files queued to a specific printer have a higher 
priority than files queued to a printer class. </P>
<P>
Each file is printed by executing an interface script (which may be a 
shell script or executable program) and sending the standard output of 
that script to a printer-specific device or file (such as a parallel 
port or network connection). For network protocols requiring the final 
output file size the output of the interface script is sent to a file 
first and only sent to the network printer after the interface script 
is completed sucessfully. </P>
<H2>
Interface Library</H2>
<P>
The <I>interface library</I> sub-system provides a common interface to 
the <I>scheduler</I> sub-system. Functions are provided for all of the 
command messages listed in the previous section as well as opening and 
closing connections to the <I>scheduler</I>. </P>
<P>
The <I>interface library</I> also provides a common interface for 
reading and using PPD files within applications. Functions are provided 
to retrieve a printer's PPD file, mark printer options for output, 
retrieve the current media size and printable area, and write printer 
options in the correct order. </P>
<P>
The <I>interface library</I> is thread-safe so long as a separate 
connection is used by each thread that talks to the <I>scheduler</I>. <BR>
&nbsp; </P>
<H3>
HTTP Interface</H3>
<P>
Remote administration and <BR>
&nbsp; </P>
<H3>
Directory Service Interface</H3>
<P>
All CUPS schedulers on a network will periodically broadcast the list 
of available local printers to other systems on the local network(s). 
Updates are sent whenever a specific time has elapsed, when a printer 
is added or removed from the system, and optionally when the printer 
status changes. </P>
<P>
When new broadcast information is received from another CUPS server the <I>scheduler</I>
 will update its database of available network printers and their 
statuses. </P>
<H2>
Manager</H2>
<P>
The <I>manager</I> sub-system provides a command-line and graphical 
interface for adding, removing, and configuring printers on the system. 
The graphical interface also provides a list of currently available 
printers and their status. </P>
<P>
The command-line interface provides a System V &quot;lpadmin&quot; 
interface with the addition of a PPD file option 
(&quot;--ppd=filename.ppd&quot;). </P>
<H2>
Status</H2>
<P>
The <I>status</I> sub-system provides two command-line and a graphical 
interface for viewing the current printer and queue statuses. The 
command-line interfaces imitate the System V &quot;lpstat&quot; and 
&quot;cancel&quot; commands which allows for viewing of queue, printer, 
and scheduler statuses and cancelling of queued print jobs. </P>
<P>
The graphical interface shows the current printer status and list of 
queued files for the specified printer. Queued files can be removed 
from the print queue via a pull-down menu. </P>
<H2>
Control</H2>
<P>
The <I>control</I> sub-system provides two command-line interfaces that 
imitate the Berkeley &quot;lpc&quot; and &quot;lprm&quot; commands 
which allow for viewing of queue, printer, and scheduler statuses and 
cancelling of queued print jobs. </P>
<H2>
Queue</H2>
<P>
The <I>queue</I> sub-system provides two command-line interfaces and a 
graphics interface for queuing of files to a specific printer or class. 
The command-line interfaces imitate the System V &quot;lp&quot; and 
Berkeley &quot;lpr&quot; commands. </P>
<P>
The graphical interface allows for selection of the destination printer 
or class and setting of printer-specific options, the number of copies, 
the job priority, and the job title. </P>
<H2>
Option Panel</H2>
<P>
The <I>option panel</I> sub-system provides a graphical interface to a 
printer's PPD file. The option panel shows all printer-specific options 
as well as file-specific options (N-up, even/odd pages, image 
resolution, etc.) Each category of options is placed on an &quot;index 
card&quot; that can be accessed by clicking on its tab. </P>
<P>
The options are written to the standard output file. </P>
<H2>
Text Filter</H2>
<P>
The <I>text filter</I> sub-system provides an output filter for text 
encoded using the ISO-8859-1 (Unicode) encoding. This encoding is 
backwards-compatible with the American Standard Code for Information 
Interchange (ASCII). </P>
<P>
The <I>text filter</I> formats text files according to the options set 
by the user. Standard text options include: <BR>
&nbsp; </P>
<CENTER>
<TABLE BORDER="1" WIDTH="80%">
    <TR>
        <TH>Option</TH>
        <TH>Description</TH>
    </TR>
    <TR>
        <TD>cpi={10,12,17}</TD>
        <TD>Set the number of horizontal characters per inch.</TD>
    </TR>
    <TR>
        <TD>lpi={6,8}</TD>
        <TD>Set the number of vertical lines per inch.</TD>
    </TR>
    <TR>
        <TD>left=##{in,cm,mm}</TD>
        <TD>Sets the left margin</TD>
    </TR>
    <TR>
        <TD>right=##{in,cm,mm}</TD>
        <TD>Sets the right margin</TD>
    </TR>
    <TR>
        <TD>top=##{in,cm,mm}</TD>
        <TD>Sets the top margin</TD>
    </TR>
    <TR>
        <TD>bottom=##{in,cm,mm}</TD>
        <TD>Sets the bottom margin</TD>
    </TR>
    <TR>
        <TD>pagesize=????</TD>
        <TD>Sets the page size</TD>
    </TR>
    <TR>
        <TD>columns=##</TD>
        <TD>Sets the number of text columns</TD>
    </TR>
    <TR>
        <TD>colspace=##{in,cm,mm}</TD>
        <TD>Sets the space between text columns</TD>
    </TR>
</TABLE>
</CENTER>
<P>
The <I>text filter</I> can output text, PostScript, PCL, and ESC/P 
data. </P>
<H2>
Image Filter</H2>
<P>
The <I>image filter</I> sub-system converts image files to PostScript 
using the ASCIIHex or ASCII85 encodings. </P>
<P>
The <I>image filter</I> formats image files according to the options 
set by the user. Standard image options include: <BR>
&nbsp; </P>
<CENTER>
<TABLE BORDER="1" WIDTH="80%">
    <TR>
        <TH>Option</TH>
        <TH>Description</TH>
    </TR>
    <TR>
        <TD>ppi=##</TD>
        <TD>Set the number of pixels per inch.</TD>
    </TR>
    <TR>
        <TD>zoom=###</TD>
        <TD>Set the amount of the page to be used (default 100%).</TD>
    </TR>
    <TR>
        <TD>left=##{in,cm,mm}</TD>
        <TD>Sets the left margin</TD>
    </TR>
    <TR>
        <TD>right=##{in,cm,mm}</TD>
        <TD>Sets the right margin</TD>
    </TR>
    <TR>
        <TD>top=##{in,cm,mm}</TD>
        <TD>Sets the top margin</TD>
    </TR>
    <TR>
        <TD>bottom=##{in,cm,mm}</TD>
        <TD>Sets the bottom margin</TD>
    </TR>
    <TR>
        <TD>pagesize=????</TD>
        <TD>Sets the page size</TD>
    </TR>
</TABLE>
</CENTER>
<H2>
PostScript Filter</H2>
<P>
The <I>postscript filter</I> sub-system filters PostScript files to 
added printer-specific options and to apply PostScript filter options 
including: <BR>
&nbsp; </P>
<CENTER>
<TABLE BORDER="1" WIDTH="80%">
    <TR>
        <TH>Option</TH>
        <TH>Description</TH>
    </TR>
    <TR>
        <TD>nup={1,2,4,9}</TD>
        <TD>Selects N-up printing (1, 2, 4, or 9 page images per page)</TD>
    </TR>
    <TR>
        <TD>pages={all,even,odd} pages=reversed pages={##,##-##,##-}</TD>
        <TD>Selects pages for printing</TD>
    </TR>
    <TR>
        <TD>landscape</TD>
        <TD>Rotates the page 90 degrees</TD>
    </TR>
    <TR>
        <TD>pagesize=????</TD>
        <TD>Sets the page size</TD>
    </TR>
</TABLE>
</CENTER>
<H2>
HPGL Filter</H2>
<P>
The <I>hpgl filter</I> sub-system converts HPGL and HPGL/2 files to 
PostScript. </P>
<P>
The <I>hpgl filter</I> formats HPGL files according to the options set 
by the user. Standard HPGL options include: <BR>
&nbsp; </P>
<CENTER>
<TABLE BORDER="1" WIDTH="80%">
    <TR>
        <TH>Option</TH>
        <TH>Description</TH>
    </TR>
    <TR>
        <TD>fitplot</TD>
        <TD>Fit the plot to the printable area</TD>
    </TR>
    <TR>
        <TD>colors={black,gray,color}</TD>
        <TD>Select black, grayscale, or color output.</TD>
    </TR>
    <TR>
        <TD>penwidth=##{in,cm,mm}</TD>
        <TD>Set the default pen width.</TD>
    </TR>
    <TR>
        <TD>pagesize=????</TD>
        <TD>Sets the page size</TD>
    </TR>
</TABLE>
</CENTER>
<H1>
Detailed Design</H1>
<H2>
Scheduler</H2>
<P>
The <I>scheduler</I> sub-system is composed of ??? functions that 
perform the four tasks outlined in Section 3.1: <BR>
&nbsp; </P>
<CENTER>
<TABLE BORDER="1" WIDTH="80%">
    <TR>
        <TH>Task</TH>
        <TH>Function</TH>
    </TR>
    <TR>
        <TD>Command Processing</TD>
        <TD>CommandProcessing()</TD>
    </TR>
    <TR>
        <TD>Local Queue Processing</TD>
        <TD>LocalProcessing()</TD>
    </TR>
    <TR>
        <TD>Remote Queue Processing</TD>
        <TD>RemoteProcessing()</TD>
    </TR>
    <TR>
        <TD>Network Information Processing</TD>
        <TD>NetworkProcessing()</TD>
    </TR>
</TABLE>
</CENTER>
<P>
These functions are called by the main() function when new data or 
connections are detected. The main() function uses the select() system 
call to minimize CPU usage. </P>
<H3>
Global Variables</H3>
<P>
The following global state variables are maintained by the <I>scheduler</I>
 sub-systems: <BR>
&nbsp; </P>
<CENTER>
<TABLE BORDER="1" WIDTH="80%">
    <TR>
        <TH>Variable</TH>
        <TH>Type</TH>
        <TH>Description</TH>
    </TR>
    <TR>
        <TD>InputSet</TD>
        <TD>fd_set</TD>
        <TD>Input set for select() in the main() function.</TD>
    </TR>
    <TR>
        <TD>OutputSet</TD>
        <TD>fd_set</TD>
        <TD>Output set for select() in the main() function.</TD>
    </TR>
    <TR>
        <TD>CommandListenSocket</TD>
        <TD>int</TD>
        <TD>A socket that listens for new connections from local 
            clients.</TD>
    </TR>
    <TR>
        <TD>CommandSockets</TD>
        <TD>int [MAX_CLIENTS]</TD>
        <TD>Active local client sockets.</TD>
    </TR>
    <TR>
        <TD>NumCommandSockets</TD>
        <TD>int</TD>
        <TD>The number of local clients currently connected.</TD>
    </TR>
    <TR>
        <TD>InfoSockets</TD>
        <TD>int [MAX_INTERFACES]</TD>
        <TD>Sockets that listen for network updates of printers.</TD>
    </TR>
    <TR>
        <TD>NunInfoSockets</TD>
        <TD>int [MAX_INTERFACES]</TD>
        <TD>Sockets that listen for network updates of printers.</TD>
    </TR>
    <TR>
        <TD>RemoteListenSocket</TD>
        <TD>int</TD>
        <TD>A socket that listens for LPD protocol connections.</TD>
    </TR>
    <TR>
        <TD>RemoteSockets</TD>
        <TD>lpd_t [MAX_LPD]</TD>
        <TD>Incoming/outgoing print jobs via LPD protocol.</TD>
    </TR>
    <TR>
        <TD>NumRemoteSockets</TD>
        <TD>int</TD>
        <TD>Number of LPD connections.</TD>
    </TR>
</TABLE>
</CENTER>
<H3>
CommandProcessing()</H3>
<H4>
do_add_printer()</H4>
<H4>
do_get_default_options()</H4>
<H4>
do_get_ppd_file()</H4>
<H4>
do_get_printer_list()</H4>
<H4>
do_get_printer_status()</H4>
<H4>
do_get_queue_status()</H4>
<H4>
do_query_printer()</H4>
<H4>
do_queue_file()</H4>
<H4>
do_remove_printer()</H4>
<H4>
do_requeue_file()</H4>
<H4>
do_set_default_options()</H4>
<H4>
do_set_printer_status()</H4>
<H4>
do_unqueue_file()</H4>
<H4>
do_update_printer()</H4>
<H3>
LocalProcessing()</H3>
<H4>
close_device()</H4>
<H4>
find_next_job()</H4>
<H4>
finish_job()</H4>
<H4>
open_device()</H4>
<H4>
scan_devices()</H4>
<H4>
start_job()</H4>
<H3>
RemoteProcessing()</H3>
<H4>
accept_connection()</H4>
<H4>
make_connection()</H4>
<H4>
receive_control_file()</H4>
<H4>
receive_job_file()</H4>
<H4>
send_control_file()</H4>
<H4>
send_job_file()</H4>
<H3>
NetworkProcessing()</H3>
<H4>
get_message()</H4>
<H4>
add_printer()</H4>
<H4>
remove_printer()</H4>
<H4>
update_printer()</H4>
<H4>
add_server()</H4>
<H2>
Interface Library</H2>
<H3>
cupsAddPrinter()</H3>
<H3>
cupsCheckPage()</H3>
<H3>
cupsChoosePPDOption()</H3>
<H3>
cupsChoosePPDOptions()</H3>
<H3>
cupsClearPageList()</H3>
<H3>
cupsClose()</H3>
<H3>
cupsGetDefaultOptions()</H3>
<H3>
cupsGetError()</H3>
<H3>
cupsGetErrorString()</H3>
<H3>
cupsGetMessage()</H3>
<H3>
cupsGetPageList()</H3>
<H3>
cupsGetPPDFile()</H3>
<H3>
cupsGetPrinterAccess()</H3>
<H3>
cupsGetPrinterList()</H3>
<H3>
cupsGetPrinterStatus()</H3>
<H3>
cupsGetQueueStatus()</H3>
<H3>
cupsLogPage()</H3>
<H3>
cupsOpen()</H3>
<H3>
cupsQueryPrinter()</H3>
<H3>
cupsQueueFile()</H3>
<H3>
cupsRemovePrinter()</H3>
<H3>
cupsRequeueFile()</H3>
<H3>
cupsSendMessage()</H3>
<H3>
cupsSetDefaultOptions()</H3>
<H3>
cupsSetPrinterAccess()</H3>
<H3>
cupsSetPrinterStatus()</H3>
<H3>
cupsUnqueueFile()</H3>
<H3>
cupsUpdatePrinter()</H3>
<H3>
cupsWritePPDOptions()</H3>
<H2>
Manager</H2>
<H2>
Status</H2>
<H2>
Control</H2>
<H2>
Queue</H2>
<H2>
Option Panel</H2>
<H2>
Text Filter</H2>
<H2>
Image Filter</H2>
<H2>
PostScript Filter</H2>
<H2>
HPGL Filter</H2>
<H1 TYPE="A" VALUE="1">
Glossary</H1>
<H2>
Acronyms</H2>
<DL>
    <DT>
    ASCII
    <DD>
    American Standard Code for Information Interchange
    <DT>
    CUPS
    <DD>
    Common UNIX Printing System
    <DT>
    ESC/P
    <DD>
    EPSON Standard Code for Printers
    <DT>
    HPGL
    <DD>
    Hewlett-Packard Graphics Language
    <DT>
    ISO
    <DD>
    International Standards Organization
    <DT>
    LPD
    <DD>
    Line Printer Daemon
    <DT>
    PCL
    <DD>
    Page Control Language
    <DT>
    PPD
    <DD>
    PostScript Printer Description
</DL>
</BODY>
</HTML>
